<!DOCTYPE html>
<html lang="ro">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mate pentru Copii</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.log('SW Registration Failed', err));
        }
    </script>
</head>

<body>
    <div class="container">
        <!-- Header: Coins & Store & Mute -->
        <div class="header-bar">
            <div id="coin-display">ğŸª™ <span id="coin-count">0</span></div>
            <div class="header-controls">
                <button id="reset-btn" class="icon-btn" title="È˜terge Progresul">ğŸ—‘ï¸</button>
                <button id="mute-btn" class="icon-btn">ğŸ”Š</button>
                <button id="open-store-btn" class="icon-btn">ğŸª Magazin</button>
            </div>
        </div>

        <!-- Ecran de Start -->
        <div id="welcome-screen" class="screen active">
            <div class="start-header">
                <h1>Mate DistractivÄƒ! ğŸˆ</h1>
                <p>Alege jocul:</p>
            </div>

            <div id="mode-selection" class="mode-grid">
                <button onclick="selectMode('math')" class="mode-card">
                    <div class="mode-icon">ğŸ”¢</div>
                    <div class="mode-title">Calcule</div>
                </button>
                <button onclick="selectMode('series')" class="mode-card">
                    <div class="mode-icon">ğŸ“‰</div>
                    <div class="mode-title">È˜iruri</div>
                </button>
                <button onclick="selectMode('neighbors')" class="mode-card">
                    <div class="mode-icon">ğŸ˜ï¸</div>
                    <div class="mode-title">Vecini</div>
                </button>
                <button onclick="selectMode('signs')" class="mode-card">
                    <div class="mode-icon">ğŸ•µï¸</div>
                    <div class="mode-title">Detectiv</div>
                </button>
            </div>

            <div id="level-selection" class="hidden">
                <p>Alege nivelul:</p>
                <button onclick="startGame(1)" class="big-btn level-btn easy">UÈ™or ğŸŸ¢</button>
                <button onclick="startGame(2)" class="big-btn level-btn medium">Mediu ğŸŸ¡</button>
                <button onclick="startGame(3)" class="big-btn level-btn hard">Expert ğŸ”´</button>
                <button onclick="showModes()" class="big-btn"
                    style="background:#7f8c8d; font-size: 1rem; padding: 10px;">â¬… Ãnapoi</button>
            </div>

            <div class="leaderboard-container">
                <h3>ğŸ† Top JucÄƒtori ğŸ†</h3>
                <table id="leaderboard-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Scor</th>
                            <th>Timp</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ecran Magazin -->
        <div id="store-screen" class="screen hidden">
            <h1>Magazinul UrsuleÈ›ului ğŸª</h1>
            <p>Ai: ğŸª™ <span id="store-coin-count">0</span></p>
            <div id="store-grid" class="store-grid">
                <!-- Items generated by JS -->
            </div>
            <button id="close-store-btn" class="big-btn">Ãnapoi ğŸ”™</button>
        </div>

        <!-- Ecran Joc -->
        <div id="game-screen" class="screen hidden">
            <div id="mascot-container">
                <div id="mascot-wrapper">
                    <div id="mascot">ğŸ»</div>
                    <div id="mascot-accessory" class="accessory"></div>
                </div>
                <div id="mascot-message">Salut!</div>
            </div>
            <div class="progress-bar">
                <div id="progress-fill"></div>
            </div>
            <div class="question-container">
                <h2 id="question-text">5 + 1 = ?</h2>
                <div id="visual-aid"></div>
            </div>
            <div id="answers-container" class="answers-grid">
                <!-- Butoanele vor fi generate aici -->
            </div>
            <div id="feedback" class="hidden"></div>
        </div>

        <!-- Ecran Rezultate -->
        <div id="results-screen" class="screen hidden">
            <h1>Bravo! ğŸ‰</h1>

            <div id="result-mascot-container">
                <!-- Cloned mascot appears here -->
            </div>

            <div class="score-card">
                <p>Scor Final:</p>
                <h2 id="final-score">8 / 10</h2>
                <p class="time-stat">Timp: <span id="final-time">00:00</span> â±ï¸</p>
            </div>

            <div id="name-input-container" class="hidden">
                <input type="text" id="player-name" placeholder="Scrie-È›i numele..." maxlength="10">
                <button id="save-score-btn" class="big-btn" style="padding: 10px 20px; font-size: 1rem;">SalveazÄƒ
                    ğŸ’¾</button>
            </div>

            <div id="report-container" class="report-list">
                <!-- Raportul va fi generat aici -->
            </div>
            <button id="restart-btn" class="big-btn">JoacÄƒ din nou ğŸ”„</button>
        </div>
    </div>
    <script src="script.js"></script>
</body>

</html>
{
    "name": "Mate DistractivÄƒ",
    "short_name": "Mate",
    "start_url": "./index.html",
    "display": "standalone",
    "background_color": "#f0f8ff",
    "theme_color": "#4ecdc4",
    "orientation": "portrait",
    "icons": [
        {
            "src": "icon.png",
            "sizes": "512x512",
            "type": "image/png"
        }
    ]
}
const TOTAL_QUESTIONS = 10;
let currentQuestionIndex = 0;
let score = 0;
let userHistory = [];
let currentLevel = 1; // 1: Easy, 2: Medium, 3: Hard
let startTime = 0;
let selectedMode = 'math'; // 'math', 'series', 'neighbors'

function selectMode(mode) {
    selectedMode = mode;
    document.getElementById('mode-selection').classList.add('hidden');
    document.getElementById('level-selection').classList.remove('hidden');
}

function showModes() {
    document.getElementById('mode-selection').classList.remove('hidden');
    document.getElementById('level-selection').classList.add('hidden');
}

// Persistence State
let playerData = {
    coins: 0,
    inventory: [], // IDs of owned items
    equipped: null, // ID of equipped item
    leaderboard: [] // [{score: 10, time: 120, date: '...'}]
};

// Store Items
const storeItems = [
    { id: 'hat_top', name: 'Joben', price: 10, icon: 'ğŸ©' },
    { id: 'hat_cowboy', name: 'PÄƒlÄƒrie Cowboy', price: 15, icon: 'ğŸ¤ ' },
    { id: 'glasses_sun', name: 'Ochelari', price: 20, icon: 'ğŸ•¶ï¸' },
    { id: 'crown', name: 'CoroanÄƒ', price: 50, icon: 'ğŸ‘‘' },
    { id: 'bow', name: 'Funda', price: 5, icon: 'ğŸ€' }
];

const screens = {
    welcome: document.getElementById('welcome-screen'),
    game: document.getElementById('game-screen'),
    results: document.getElementById('results-screen'),
    store: document.getElementById('store-screen')
};

const mascot = {
    el: document.getElementById('mascot'),
    accessoryEl: document.getElementById('mascot-accessory'),
    msg: document.getElementById('mascot-message'),

    setEmotion: function (emotion) {
        this.el.className = '';
        void this.el.offsetWidth;

        if (emotion === 'happy') {
            this.el.textContent = 'ğŸ¥³';
            this.el.classList.add('bounce');
            this.say("Bravo!");
        } else if (emotion === 'sad') {
            this.el.textContent = 'ğŸ˜¢';
            this.el.classList.add('shake');
            this.say("Oh nu!");
        } else if (emotion === 'thinking') {
            this.el.textContent = 'ğŸ¤”';
            this.msg.style.opacity = 0;
        } else {
            this.el.textContent = 'ğŸ»'; // Idle
            this.msg.style.opacity = 0;
        }
    },
    say: function (text) {
        this.msg.textContent = text;
        this.msg.style.opacity = 1;
    },
    updateAppearance: function () {
        if (playerData.equipped) {
            const item = storeItems.find(i => i.id === playerData.equipped);
            this.accessoryEl.textContent = item ? item.icon : '';
        } else {
            this.accessoryEl.textContent = '';
        }
    },
    cloneToResult: function () {
        const resultContainer = document.getElementById('result-mascot-container');
        resultContainer.innerHTML = ''; // Clear previous

        const wrapper = document.createElement('div');
        wrapper.id = 'mascot-wrapper';

        const bear = document.createElement('div');
        bear.id = 'mascot';
        bear.textContent = 'ğŸ¥³'; // Happy bear
        bear.classList.add('bounce');

        const acc = document.createElement('div');
        acc.id = 'mascot-accessory';
        acc.className = 'accessory';

        if (playerData.equipped) {
            const item = storeItems.find(i => i.id === playerData.equipped);
            acc.textContent = item ? item.icon : '';
        }

        wrapper.appendChild(bear);
        wrapper.appendChild(acc);
        resultContainer.appendChild(wrapper);
    }
};

function loadData() {
    const saved = localStorage.getItem('mathApp_data');
    if (saved) {
        let loaded = JSON.parse(saved);
        // Merge to ensure new fields exist
        playerData = { ...playerData, ...loaded };
        if (!playerData.leaderboard) playerData.leaderboard = [];
    }
    updateCoinDisplay();
    mascot.updateAppearance();
    renderLeaderboard();
}

function saveData() {
    localStorage.setItem('mathApp_data', JSON.stringify(playerData));
    updateCoinDisplay();
}

function updateCoinDisplay() {
    document.getElementById('coin-count').textContent = playerData.coins;
    document.getElementById('store-coin-count').textContent = playerData.coins;
}

function formatTime(seconds) {
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
}

// Helper to migrate old data without names
function renderLeaderboard() {
    const tbody = document.getElementById('leaderboard-body');
    tbody.innerHTML = '';

    // Sort: High score desc, Low time asc
    const sorted = [...playerData.leaderboard].sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        return a.time - b.time;
    }).slice(0, 5); // Start with top 5

    sorted.forEach((entry, i) => {
        const tr = document.createElement('tr');
        const name = entry.name ? entry.name : 'JucÄƒtor';
        tr.innerHTML = `
            <td>${i + 1}. ${name}</td>
            <td>${entry.score}</td>
            <td>${formatTime(entry.time)}</td>
        `;
        tbody.appendChild(tr);
    });

    if (sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">JoacÄƒ pentru a fi primul!</td></tr>';
    }
}

function showScreen(screenName) {
    Object.values(screens).forEach(s => {
        s.classList.remove('active');
        s.classList.add('hidden');
    });
    screens[screenName].classList.remove('hidden');
    screens[screenName].classList.add('active');
}

// Event Listeners
// document.getElementById('start-btn').addEventListener('click', startGame);
document.getElementById('restart-btn').addEventListener('click', () => {
    // Save coins from session if any logic needed, actually coins saved immediately on earn
    showScreen('welcome');
    // Ensure we reset to mode selection state
    document.getElementById('mode-selection').classList.remove('hidden');
    document.getElementById('level-selection').classList.add('hidden');
    renderLeaderboard(); // Refresh in case updated
});
document.getElementById('open-store-btn').addEventListener('click', openStore);
document.getElementById('close-store-btn').addEventListener('click', () => showScreen('welcome'));

// Load data on start
loadData();

function startGame(level) {
    currentLevel = level;
    currentQuestionIndex = 0;
    score = 0;
    userHistory = [];
    startTime = Date.now(); // Start Timer
    showScreen('game');
    mascot.setEmotion('idle');
    nextQuestion();
}

function generateQuestion() {
    let type = selectedMode;

    // In expert math mode, random chance to see other types
    if (selectedMode === 'math' && currentLevel >= 2) {
        let rand = Math.random();
        if (rand < 0.2) type = 'series';
        else if (rand < 0.4 && currentLevel >= 2) type = 'neighbors'; // Neighbors mainly for 2+
        else if (rand < 0.6 && currentLevel === 3) type = 'signs';
    }

    if (type === 'series') return generateSeries();
    if (type === 'neighbors') return generateNeighbors();
    if (type === 'signs') return generateSigns();

    // --- MATH MODE (Default) ---
    // Level scaling: 
    // Easy: 1-10 (+/- 1,2)
    // Medium: 1-20 (+/- 1-5)
    // Expert: 1-100 (+/- 1-10) + Mystery Mode Logic

    let num1, num2, operator, isAddition;
    let isValid = false;
    let maxNum = currentLevel >= 2 ? 20 : 10;
    let maxMove = currentLevel >= 2 ? 5 : 2;
    if (currentLevel === 3) { maxNum = 50; maxMove = 10; }

    while (!isValid) {
        num1 = Math.floor(Math.random() * maxNum) + 1;
        num2 = Math.floor(Math.random() * maxMove) + 1;
        isAddition = Math.random() > 0.5;

        if (isAddition) {
            operator = '+';
            isValid = true;
        } else {
            operator = '-';
            if (num1 - num2 >= 0) isValid = true;
        }
    }

    let correctAnswer = isAddition ? num1 + num2 : num1 - num2;
    let questionStr = `${num1} ${operator} ${num2}`;

    // Expert Mode Logic (Mystery) only for Math Mode Level 3
    let isExpert = currentLevel === 3;
    if (isExpert) {
        const type = Math.floor(Math.random() * 3);
        if (type === 1) {
            questionStr = `? ${operator} ${num2} = ${correctAnswer}`;
            correctAnswer = num1;
        } else if (type === 2) {
            questionStr = `${num1} ${operator} ? = ${correctAnswer}`;
            correctAnswer = num2;
        }
    }

    // Render Visuals if not Expert
    const visContainer = document.getElementById('visual-aid');
    visContainer.innerHTML = '';

    if (!isExpert && currentLevel <= 2 && type === 'math') {
        // Simple visuals: render fruits
        // 3 + 2 -> ğŸğŸğŸ + ğŸğŸ
        let html = '';
        for (let i = 0; i < num1; i++) html += 'ğŸ';
        html += ` <b>${operator}</b> `;
        for (let i = 0; i < num2; i++) html += 'ğŸŒ';
        visContainer.innerHTML = html;
    }

    return {
        text: questionStr,
        correct: correctAnswer,
        isExpert: isExpert && questionStr.includes('=') && type === 'math',
        type: 'math'
    };
}

function generateSeries() {
    let maxStart, stepMax;

    switch (currentLevel) {
        case 1: // Easy
            maxStart = 10;
            stepMax = 1;
            break;
        case 2: // Medium
            maxStart = 20;
            stepMax = 2;
            break;
        case 3: // Expert
            maxStart = 50;
            stepMax = 5;
            break;
        default: maxStart = 10; stepMax = 1;
    }

    let start = Math.floor(Math.random() * maxStart) + 1;
    let step = Math.floor(Math.random() * stepMax) + 1;

    let n1 = start;
    let n2 = start + step;
    let n3 = start + step * 2;
    let correct = start + step * 3;

    return {
        text: `${n1}, ${n2}, ${n3}, ?`,
        correct: correct,
        type: 'series'
    };
}

function generateNeighbors() {
    let maxCenter;
    switch (currentLevel) {
        case 1: maxCenter = 10; break;
        case 2: maxCenter = 30; break;
        case 3: maxCenter = 100; break;
        default: maxCenter = 10;
    }

    // Ensure center is at least 2 so we have a left neighbor
    let center = Math.floor(Math.random() * (maxCenter - 2)) + 2;
    let correct = `${center - 1} È™i ${center + 1}`;

    return {
        text: `_ ${center} _`,
        correct: correct,
        center: center,
        type: 'neighbors'
    };
}

function generateSigns() {
    // Detectiv Mode: Identify Operator or Rule

    // Level 1: Operator (+ or -)
    // 3 ? 1 = 4 -> Answer: "+"
    if (currentLevel === 1) {
        let num1 = Math.floor(Math.random() * 8) + 2;
        let num2 = Math.floor(Math.random() * 2) + 1;
        let res = Math.random() > 0.5 ? num1 + num2 : num1 - num2;
        let isAdd = (num1 + num2 === res); // Determine if it was addition or subtraction

        return {
            text: `${num1} [ ? ] ${num2} = ${res}`,
            correct: isAdd ? '+' : '-',
            type: 'signs'
        };
    }

    // Level 2 & 3: Series Rule (e.g. 2 -> 4 -> 6)
    // Answer: "+2"
    let start = Math.floor(Math.random() * 10) + 1;
    let step = Math.floor(Math.random() * (currentLevel === 3 ? 4 : 2)) + 1; // 1 to 2 or 4
    let isAdd = true; // For simplicity in series usually going up, but can add down later

    let n1 = start;
    let n2 = start + step;
    let n3 = start + step * 2;

    return {
        text: `${n1} â¡ ${n2} â¡ ${n3}`,
        correct: `+${step}`,
        type: 'signs'
    };
}

function nextQuestion() {
    if (currentQuestionIndex >= TOTAL_QUESTIONS) {
        showResults();
        return;
    }

    mascot.setEmotion('thinking');

    const progressFill = document.getElementById('progress-fill');
    progressFill.style.width = `${((currentQuestionIndex) / TOTAL_QUESTIONS) * 100}%`;

    const q = generateQuestion();
    // If expert mode already has =, don't add " = ?"
    if (q.isExpert || q.type === 'signs') {
        document.getElementById('question-text').textContent = q.text;
    } else {
        document.getElementById('question-text').textContent = `${q.text} = ?`;
    }

    generateAnswers(q.correct, q.text);
}

// Store Logic
function openStore() {
    showScreen('store');
    renderStore();
}

function renderStore() {
    const grid = document.getElementById('store-grid');
    grid.innerHTML = '';

    storeItems.forEach(item => {
        const isOwned = playerData.inventory.includes(item.id);
        const isEquipped = playerData.equipped === item.id;

        const el = document.createElement('div');
        el.className = `store-item ${isOwned ? 'owned' : ''}`;

        let actionBtn = '';
        if (isOwned) {
            if (isEquipped) {
                actionBtn = `<button class="equip-btn" disabled>Purtat</button>`;
            } else {
                actionBtn = `<button class="equip-btn" onclick="equipItem('${item.id}')">PoartÄƒ</button>`;
            }
        } else {
            const canAfford = playerData.coins >= item.price;
            actionBtn = `<button class="buy-btn" onclick="buyItem('${item.id}')" ${canAfford ? '' : 'disabled'}>CumpÄƒrÄƒ ğŸª™${item.price}</button>`;
        }

        el.innerHTML = `
            <div class="item-icon">${item.icon}</div>
            <strong>${item.name}</strong>
            ${actionBtn}
        `;
        grid.appendChild(el);
    });
}

function buyItem(id) {
    const item = storeItems.find(i => i.id === id);
    if (item && playerData.coins >= item.price) {
        playerData.coins -= item.price;
        playerData.inventory.push(id);
        saveData();
        renderStore();
        SoundSystem.playCorrect(); // Reuse sound
    } else {
        SoundSystem.playWrong();
    }
}

function equipItem(id) {
    if (playerData.inventory.includes(id)) {
        playerData.equipped = id;
        saveData();
        renderStore();
        mascot.updateAppearance();
    }
}

function generateAnswers(correct, questionText) {
    const container = document.getElementById('answers-container');
    container.innerHTML = '';

    let answers = new Set();
    answers.add(correct);

    // Check if it's a "Neighbors" question or "Signs" (string answers)
    const isStringAnswer = typeof correct === 'string';

    while (answers.size < 3) {
        if (isStringAnswer) {
            // Logic for Signs/Neighbors distractors
            if (correct === '+' || correct === '-') {
                answers.add(correct === '+' ? '-' : '+');
                answers.add('='); // Just a dummy
            } else if (correct.startsWith('+')) {
                // Rule like +2
                let num = parseInt(correct.substring(1));
                answers.add(`+${num + 1}`);
                answers.add(`+${num + 2}`);
                answers.add(`-${num}`);
            } else if (correct.includes('È™i')) {
                // Neighbor logic
                let rnd = Math.floor(Math.random() * 10) + 1;
                let fake = `${rnd - 1} È™i ${rnd + 1}`;
                if (fake !== correct && rnd > 1) answers.add(fake);
            }
        } else {
            // Normal Number Logic
            let offset = Math.floor(Math.random() * 5) - 2;
            if (offset === 0) continue;

            let wrong = correct + offset;
            if (wrong >= 0) {
                answers.add(wrong);
            } else {
                answers.add(correct + Math.abs(offset));
            }
        }
    }

    const answersArray = Array.from(answers).sort(() => Math.random() - 0.5);

    answersArray.forEach(ans => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.textContent = ans; // Works for both numbers and strings
        // For visual consistency, maybe make text smaller if string is long
        if (isStringAnswer) btn.style.fontSize = '1.2rem';

        btn.onclick = () => handleAnswer(ans, correct, questionText, btn);
        container.appendChild(btn);
    });
}

// --- Sound System ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let isMuted = false;

document.getElementById('mute-btn').addEventListener('click', () => {
    isMuted = !isMuted;
    const btn = document.getElementById('mute-btn');
    btn.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
});

document.getElementById('reset-btn').addEventListener('click', () => {
    if (confirm('Sigur vrei sÄƒ È™tergi tot progresul (bani, accesorii, clasament)?')) {
        localStorage.removeItem('mathApp_data');
        location.reload();
    }
});

const SoundSystem = {
    playTone: function (freq, type, duration) {
        if (isMuted) return;
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    },

    playCorrect: function () {
        // High pitch happy sound
        this.playTone(600, 'sine', 0.1);
        setTimeout(() => this.playTone(800, 'sine', 0.2), 100);
    },

    playWrong: function () {
        // Low pitch "womp womp"
        this.playTone(150, 'sawtooth', 0.3);
        setTimeout(() => this.playTone(100, 'sawtooth', 0.4), 200);
    },

    playWin: function () {
        // Victory fanfare
        const now = audioCtx.currentTime;
        [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
            setTimeout(() => this.playTone(freq, 'square', 0.3), i * 150);
        });
    }
};

function handleAnswer(selected, correct, questionText, btnElement) {
    // Disable all buttons
    const buttons = document.querySelectorAll('.answer-btn');
    buttons.forEach(b => b.disabled = true);

    const isCorrect = selected === correct;

    if (isCorrect) {
        btnElement.classList.add('correct');
        SoundSystem.playCorrect();
        mascot.setEmotion('happy');
        score++;
        // Reward Coin
        playerData.coins++;
        saveData();
    } else {
        btnElement.classList.add('wrong');
        SoundSystem.playWrong();
        mascot.setEmotion('sad');
        // Arata si raspunsul corect
        buttons.forEach(b => {
            if (parseInt(b.textContent) === correct) {
                b.classList.add('correct');
            }
        });
    }

    userHistory.push({
        question: questionText,
        correct: correct,
        user: selected,
        isCorrect: isCorrect
    });

    currentQuestionIndex++;

    // Asteapta putin inainte de urmatoarea intrebare
    setTimeout(() => {
        nextQuestion();
    }, 1500);
}

// Save Score Button Logic
document.getElementById('save-score-btn').addEventListener('click', () => {
    const name = document.getElementById('player-name').value.trim() || 'Anonim';

    // Add to leaderboard
    playerData.leaderboard.push({
        score: score,
        time: Math.floor((Date.now() - startTime) / 1000),
        name: name,
        date: new Date().toISOString()
    });

    saveData();
    renderLeaderboard();

    // Disable inputs
    document.getElementById('player-name').disabled = true;
    document.getElementById('save-score-btn').disabled = true;
    document.getElementById('save-score-btn').textContent = "Salvat! âœ…";
});

function showResults() {
    showScreen('results');

    // Calculate Time
    const endTime = Date.now();
    const elapsedSeconds = Math.floor((endTime - startTime) / 1000);
    const timeStr = formatTime(elapsedSeconds);

    document.getElementById('final-score').textContent = `${score} / ${TOTAL_QUESTIONS}`;
    document.getElementById('final-time').textContent = timeStr;

    // Show Name Input if Score > 0
    const inputContainer = document.getElementById('name-input-container');
    const nameInput = document.getElementById('player-name');
    const saveBtn = document.getElementById('save-score-btn');

    if (score > 0) {
        inputContainer.classList.remove('hidden');
        nameInput.value = '';
        nameInput.disabled = false;
        saveBtn.disabled = false;
        saveBtn.textContent = 'SalveazÄƒ ğŸ’¾';
    } else {
        inputContainer.classList.add('hidden');
    }

    // Show Mascot
    mascot.cloneToResult();

    // Play sound & Confetti
    if (score > 0) {
        SoundSystem.playWin();
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 }
        });
    }

    const reportContainer = document.getElementById('report-container');
    reportContainer.innerHTML = '';

    userHistory.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = `report-item ${item.isCorrect ? 'correct-item' : 'wrong-item'}`;

        const statusIcon = item.isCorrect ? 'âœ”' : 'âœ˜';
        const text = document.createElement('span');
        text.innerHTML = `<strong>${index + 1}.</strong> ${item.question} = <strong>${item.correct}</strong> (Tu: ${item.user}) ${statusIcon}`;

        div.appendChild(text);
        reportContainer.appendChild(div);
    });
}

:root {
    --primary-color: #FF6B6B;
    --secondary-color: #4ECDC4;
    --accent-color: #FFE66D;
    --text-color: #2C3E50;
    --bg-color: #F7F9FC;
    --white: #FFFFFF;
}

body {
    font-family: 'Fredoka', sans-serif;
    background-color: var(--bg-color);
    background-image: url('dino.png');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    color: var(--text-color);
}

.container {
    width: 90%;
    max-width: 600px;
    background: rgba(255, 255, 255, 0.95);
    /* Slight transparency */
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    text-align: center;
    position: relative;
    overflow: hidden;
    border: 5px solid var(--secondary-color);
}

.header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.header-controls {
    display: flex;
    gap: 10px;
}

#coin-display {
    font-size: 1.5rem;
    font-weight: bold;
    background: #FFD700;
    padding: 5px 15px;
    border-radius: 20px;
    color: #333;
}

.icon-btn {
    background: white;
    border: 2px solid #ddd;
    border-radius: 10px;
    padding: 5px 10px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s;
}

.icon-btn:hover {
    background: #f0f0f0;
}

.screen {
    display: none;
    animation: fadeIn 0.5s ease;
}

.screen.active {
    display: block;
}

h1 {
    font-size: 2.5rem;
    color: var(--primary-color);
    margin-bottom: 20px;
}

h2 {
    font-size: 3rem;
    margin: 30px 0;
}

p {
    font-size: 1.2rem;
    color: #555;
}

/* Butoane */
.big-btn {
    background-color: var(--secondary-color);
    border: none;
    border-radius: 50px;
    padding: 15px 40px;
    font-size: 1.2rem;
    color: var(--white);
    cursor: pointer;
    font-family: 'Fredoka', sans-serif;
    font-weight: 600;
    margin: 10px;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 5px 0 rgba(0, 0, 0, 0.2);
    width: 100%;
    max-width: 300px;
}

.mode-btn {
    background-color: #9b59b6;
}

/* Mode Grid */
.mode-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.mode-card {
    background: white;
    border: 3px solid #eee;
    border-radius: 15px;
    padding: 15px;
    cursor: pointer;
    transition: transform 0.2s, border-color 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.mode-card:hover {
    border-color: var(--primary-color);
    transform: translateY(-5px);
}

.mode-icon {
    font-size: 3rem;
    margin-bottom: 5px;
}

.mode-title {
    font-weight: bold;
    font-size: 1.2rem;
    color: var(--text-color);
}

.level-btn.easy {
    background-color: #2ecc71;
}

.level-btn.medium {
    background-color: #f1c40f;
    color: #333;
}

.level-btn.hard {
    background-color: #e74c3c;
}

.big-btn:active {
    transform: translateY(5px);
    box-shadow: none;
}

.big-btn:hover {
    filter: brightness(1.1);
}

/* Mascot */
#mascot-container {
    margin-bottom: 0px;
    height: 120px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

#mascot-wrapper {
    position: relative;
    width: 80px;
    height: 80px;
    display: flex;
    justify-content: center;
    align-items: center;
}

#mascot {
    font-size: 4rem;
    transition: transform 0.3s;
    line-height: normal;
    z-index: 1;
}

#mascot-accessory {
    position: absolute;
    top: -15px;
    font-size: 2.5rem;
    z-index: 2;
    pointer-events: none;
}

#mascot.bounce {
    animation: bounce 0.5s infinite alternate;
}

#mascot.shake {
    animation: shake 0.5s;
}

#mascot-message {
    font-size: 1rem;
    background: #fff;
    padding: 5px 15px;
    border-radius: 15px;
    border: 1px solid #ddd;
    margin-top: 5px;
    opacity: 0;
    transition: opacity 0.3s;
}

@keyframes bounce {
    to {
        transform: translateY(-10px);
    }
}

@keyframes shake {

    0%,
    100% {
        transform: translateX(0);
    }

    25% {
        transform: translateX(-10px);
    }

    75% {
        transform: translateX(10px);
    }
}

/* Joc */
.progress-bar {
    width: 100%;
    height: 15px;
    background-color: #eee;
    border-radius: 10px;
    margin-bottom: 20px;
    overflow: hidden;
}

#progress-fill {
    height: 100%;
    background-color: var(--accent-color);
    width: 0%;
    transition: width 0.3s ease;
}

.answers-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin: 20px 0;
}

.answer-btn {
    background-color: var(--white);
    border: 3px solid var(--primary-color);
    border-radius: 15px;
    padding: 20px;
    font-size: 2rem;
    font-weight: bold;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.2s;
}

.answer-btn:hover {
    background-color: var(--primary-color);
    color: var(--white);
    transform: scale(1.05);
}

/* Feedback */
.correct {
    background-color: #4ECDC4 !important;
    border-color: #4ECDC4 !important;
    color: white !important;
}

.wrong {
    background-color: #FF6B6B !important;
    border-color: #FF6B6B !important;
    color: white !important;
}

/* Raport */
.report-list {
    text-align: left;
    max-height: 300px;
    overflow-y: auto;
    margin: 20px 0;
    border: 2px dashed #eee;
    padding: 10px;
    border-radius: 10px;
}

.report-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    border-bottom: 1px solid #eee;
    font-size: 1.1rem;
}

.report-item.correct-item {
    color: #27ae60;
}

.report-item.wrong-item {
    color: #c0392b;
}

/* Store */
.store-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin: 20px 0;
    max-height: 300px;
    overflow-y: auto;
}

.store-item {
    border: 2px solid #ddd;
    border-radius: 10px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.store-item.owned {
    background-color: #e8f8f5;
    border-color: #2ecc71;
}

.item-icon {
    font-size: 2.5rem;
    margin-bottom: 5px;
}

.buy-btn {
    background: #2ecc71;
    color: white;
    border: none;
    padding: 5px 15px;
    border-radius: 15px;
    cursor: pointer;
    margin-top: 5px;
}

.buy-btn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
}

.equip-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 5px 15px;
    border-radius: 15px;
    cursor: pointer;
    margin-top: 5px;
}

/* Visual Aids */
#visual-aid {
    margin-top: 10px;
    font-size: 1.5rem;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-direction: row;
    align-items: center;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Leaderboard */
.leaderboard-container {
    margin-top: 30px;
    background: #fff;
    padding: 15px;
    border-radius: 15px;
    border: 2px solid #eee;
}

#leaderboard-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

#leaderboard-table th,
#leaderboard-table td {
    padding: 8px;
    border-bottom: 1px solid #eee;
}

#leaderboard-table th {
    background-color: #f8f9fa;
    color: #7f8c8d;
}

#leaderboard-table tr:first-child td {
    font-weight: bold;
    color: #e67e22;
    /* Gold for #1 */
}

/* Logic for Result Mascot */
#result-mascot-container {
    height: 100px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 10px;
}

#result-mascot-container #mascot-wrapper {
    transform: scale(1.5);
    /* Make it bigger on results */
}

.time-stat {
    font-size: 1.2rem;
    color: #555;
    margin-top: 5px;
}

/* Result Inputs */
#name-input-container {
    margin: 15px 0;
    display: flex;
    gap: 10px;
    justify-content: center;
}

#player-name {
    padding: 10px;
    font-size: 1.2rem;
    border: 2px solid #ddd;
    border-radius: 10px;
    width: 150px;
    font-family: 'Fredoka', sans-serif;
}

/* Responsive */
@media (max-width: 480px) {
    .answers-grid {
        grid-template-columns: 1fr;
    }

    h2 {
        font-size: 2.5rem;
    }
}
const CACHE_NAME = 'math-app-v1';
const ASSETS_TO_CACHE = [
    './',
    './index.html',
    './style.css',
    './script.js',
    './dino.png',
    './icon.png',
    './manifest.json'
];

// Install Event: Cache files
self.addEventListener('install', (event) => {
    event.waitUntil(
        caches.open(CACHE_NAME).then((cache) => {
            console.log('[Service Worker] Caching assets');
            return cache.addAll(ASSETS_TO_CACHE);
        })
    );
});

// Activate Event: Cleanup old caches
self.addEventListener('activate', (event) => {
    event.waitUntil(
        caches.keys().then((keyList) => {
            return Promise.all(keyList.map((key) => {
                if (key !== CACHE_NAME) {
                    console.log('[Service Worker] Remove old cache', key);
                    return caches.delete(key);
                }
            }));
        })
    );
    return self.clients.claim();
});

// Fetch Event: Serve from cache, fall back to network
self.addEventListener('fetch', (event) => {
    event.respondWith(
        caches.match(event.request).then((response) => {
            return response || fetch(event.request);
        })
    );
});
